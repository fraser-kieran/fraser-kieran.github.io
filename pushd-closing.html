<!DOCTYPE HTML>
<!--
	Strata by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Pushd Experiment</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
        <link rel="apple-touch-icon" href="images/favicon.png">
        <link rel="shortcut icon" href="images/favicon.png">
        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
		<link rel="stylesheet" href="assets/css/pushd.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">
        <style>
            .btn-likert.active {
                background-color: #079198!important;
            }
            p {
                margin-bottom: 10px;
            }
            h3 {
                margin-bottom: 5px;
            }
            .btn-group-sm.btn-group-toggle {
                margin-bottom: 20px;
            }
            input {
		      border: solid thin dimgray;
              margin-bottom: 20px;
            }
            textarea {
                margin-bottom: 20px;
            }
            input[type=number] {
                -webkit-appearance: none;
                border: solid thin dimgray;
            }
            ::-webkit-scrollbar {
                width: 0px;
                background: transparent; /* make scrollbar transparent */
            }
        </style>
        
	</head>
	<body class="is-preload">

		<!-- Header -->
			<header id="header" style="background-color: black">
				<div class="inner">
					<!--<a href="" class="image avatar"><img src="images/LinkedInProfiler.png" alt="" /></a>
					<h1><strong>Kieran Fraser</strong><br />
                        PhD Candidate @ ADAPT Centre<br/>
                        Trinity College Dublin</h1>-->
				</div>
			</header>

		<!-- Main -->
			<div id="main">
                    
				<!-- One -->
                    <span class="image"><img style="width: 50%; margin: auto;" src="images/pushd/pushd_black_no_caption_3.0.png" alt="pushd logo" /></span>
					<section id="one" style="text-align: center">
                        <h3>Thank you for your participation!
                        </h3>
                        <br>
                        <div class="row">
                            <div class="col-md-4">
                                <p id="delivered" style="font-size: xx-large"></p>
                                <p># notifications delivered</p>
                            </div>
                            <div class="col-md-4">
                                <p id="answered" style="font-size: xx-large"></p>
                                <p># questionnaires answered</p>
                            </div>
                            <div class="col-md-4" id="daysLeftContainer">
                                <p id="daysLeft" style="font-size: xx-large"></p>
                                <p># days left before completion</p>
                            </div>
                        </div>
                        <br>
                        <h5 id="notCompleteMessage" style="display: none;">A link to the Prolific Academic study submission confirmation page will appear here once you have completed the 21 days of the study, please check back again soon.</h5>
                        <h5 id="alreadyCompleteMessage" style="display: none;">You have confirmed completion.</h5>
                        <button class="btn btn-success" id="completeButton" style="display: none;" onclick="goToProlific()">Confirm Completion</button>
                        <button class="btn btn-success" id="completeButtonAlt" style="display: none;" onclick="completed()">Confirm Completion</button>
					</section>
                
				<!-- Two -->
					
			</div>

		<!-- Footer -->
        <footer id="footer">
            <div class="inner">
                <ul class="copyright">
                    <li>Kieran Fraser @ ADAPT Centre</li><li>Trinity College Dublin</li>
                </ul>
            </div>
        </footer>
        
        
		<!-- Scripts -->
            <script
              src="https://code.jquery.com/jquery-3.4.1.min.js"
              integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
              crossorigin="anonymous"></script>
            <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
            
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
        
            <!-- The core Firebase JS SDK is always required and must be listed first -->
            <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-app.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-database.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase-auth.js"></script>
        
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/1.0.4/jsrender.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
        
            <script>
                
                // Your web app's Firebase configuration
                var firebaseConfig = {
                    apiKey: "AIzaSyAQu435FNTmXIcFigctYMdRO8sPLX78HI0",
                    authDomain: "pushdexp.firebaseapp.com",
                    databaseURL: "https://pushdexp.firebaseio.com",
                    projectId: "pushdexp",
                    storageBucket: "pushdexp.appspot.com",
                    messagingSenderId: "84430156157",
                    appId: "1:84430156157:web:b4fc89624448507bb05c14"
                };
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                var database = firebase.database();
                var prolificURL = null
                var userId = null
                
                
                firebase.auth().onAuthStateChanged(function(user) {
                    if (user) {
                        var isAnonymous = user.isAnonymous;
                        var uid = user.uid;
                        getProlificURLS()
                        setUp()
                        
                    } else {
                        firebase.auth().signInAnonymously().catch(function(error) {
                            $.alert({
                                title: 'Oops!',
                                type: 'red',
                                content: 'Something went wrong. Please try again later.',
                            });
                            
                        });
                    }
                });
                
                function setUp(){
                    
                    var prolificId = ''
                    try{
                        const urlParams = new URLSearchParams(window.location.search);
                        prolificId = urlParams.get('PROLIFIC_PID');
                    }catch(e){}
                    if(prolificId && prolificId!=''){
                        try{
                            database.ref('participant').orderByChild('prolificId').equalTo(prolificId)
                            .once('value')
                            .then(function(snapshot) {
                                if(snapshot && snapshot.val()!=null){
                                    var user = null
                                    for(var key in snapshot.val()){
                                        if(key && key!=null)
                                            user = snapshot.val()[key]
                                        break
                                    }
                                    console.log(user)
                                    if(user && user!=null){
                                        var size = 0
                                        var answers = 0
                                        var daysLeft = 0
                                        var alreadyCompleted = false
                                        userId = user.id
                                        
                                        
                                        if(user.hasOwnProperty('notifications'))
                                            size = Object.keys(user.notifications).length
                                        if(user.hasOwnProperty('midstudy'))
                                            answers = Object.keys(user.midstudy).length
                                        if(user.hasOwnProperty('timeCompleted'))
                                            alreadyCompleted = true
                                        
                                        var timeDiff = (new Date()).getTime() - (new Date(user.signedUp)).getTime();
                                        var daysLeft = timeDiff / (1000 * 3600 * 24);
                                        daysLeft = 21 - Math.round(daysLeft)
                                        if(daysLeft < 0)
                                            daysLeft = 0
                                        var phase = user.phase
                                        
                                        $("#delivered").html(size);
                                        $("#answered").html(answers);
                                        $("#daysLeft").html(daysLeft);
                                        
                                        if(phase && phase==4 && !alreadyCompleted){
                                            $('#completeButton').show()
                                        } 
                                        else if (alreadyCompleted){
                                            $('#alreadyCompleteMessage').show()
                                        }
                                        else{
                                            $('#notCompleteMessage').show()
                                        }
                                    }
                                    
                                }
                            });
                            // make sure phase 4 else show how many days left
                            // show closing link and update user completed.

                            /*if(userId.charAt(0) == '-' && id!='' && id!=null){
                                database.ref('participant/'+userId).update({
                                    timeCompleted: Math.round((new Date()).getTime()),
                                    prolificIdCompleted: id
                                }, function(error) {
                                    if (error) {
                                      $.alert({
                                            title: 'Error!',
                                            type: 'red',
                                            content: 'There was an error submitting. Please contact the lead researcher.',
                                        });
                                    return
                                    } else {
                                        window.location.replace("http://www.google.com");
                                    }
                                  });
                            }
                            else{
                                $.alert({
                                    title: 'Error!',
                                    type: 'red',
                                    content: 'There was an error submitting. Please contact the lead researcher.',
                                });
                                return
                            }*/
                        }catch(e){
                            $.alert({
                                title: 'Error!',
                                type: 'red',
                                content: 'There was an error submitting. Please contact the lead researcher.',
                            });
                            return
                        }
                    }
                    else{
                        // no prolific id.. get user id.. 
                        try{
                            // get userId from the p parameter!
                            const urlParams = new URLSearchParams(window.location.search);
                            userId = urlParams.get('u');
                            
                            database.ref('participant/'+userId)
                            .once('value')
                            .then(function(snapshot) {
                                if(snapshot && snapshot.val()!=null){
                                    var user = snapshot.val()
                                    
                                    var size = 0
                                    var answers = 0
                                    var daysLeft = 0
                                    var alreadyCompleted = false

                                    if(user.hasOwnProperty('notifications'))
                                        size = Object.keys(user.notifications).length
                                    if(user.hasOwnProperty('midstudy'))
                                        answers = Object.keys(user.midstudy).length
                                    if(user.hasOwnProperty('timeCompleted'))
                                        alreadyCompleted = true

                                    var phase = user.phase

                                    $("#delivered").html(size);
                                    $("#answered").html(answers);
                                    $("#daysLeftContainer").hide();

                                    if(phase && phase==4 && !alreadyCompleted){
                                        $('#completeButtonAlt').show()
                                    }
                                    else if (alreadyCompleted){
                                        $('#alreadyCompleteMessage').show()
                                        
                                    }
                                }
                                else{
                                    $.alert({
                                        title: 'Error!',
                                        type: 'red',
                                        content: 'There was an error. Please contact the lead researcher.',
                                    });
                                }
                            });
                            
                        } catch(e){
                            $.alert({
                                title: 'Error!',
                                type: 'red',
                                content: 'There was an error. Please contact the lead researcher.',
                            });
                        }
                    }
                    
                }
                
                function goToProlific(){
                    
                    if(userId!=null && prolificURL!=null){
                        database.ref('participant/'+userId).update({
                            timeCompleted: Math.round((new Date()).getTime())
                        }, function(error) {
                            if (error) {
                                $.alert({
                                    title: 'Error!',
                                    type: 'red',
                                    content: 'There was an error submitting. Please contact the lead researcher.',
                                });
                                return
                            } else {
                                window.location.replace(prolificURL);
                            }
                        })
                    }
                    else{
                        $.alert({
                            title: 'Error!',
                            type: 'red',
                            content: 'There was an error submitting. Please contact the lead researcher.',
                        });
                        return
                    }
                }
                
                function getProlificURLS(){
                    var pushRef = database.ref('prolific_urls/end')
                    .once('value')
                    .then(function(snapshot) {
                        if(snapshot && snapshot.val()!=null){
                            prolificURL = snapshot.val()
                        }
                    });
                }
                            
                function completed(){
                    if(userId!=null){
                        database.ref('participant/'+userId).update({
                            timeCompleted: Math.round((new Date()).getTime())
                        }, function(error) {
                            if (error) {
                                $.alert({
                                    title: 'Error!',
                                    type: 'red',
                                    content: 'There was an error submitting. Please contact the lead researcher.',
                                });
                                return
                            } else {
                                $.alert({
                                    title: 'Thank you!',
                                    type: 'green',
                                    content: 'Study completed. Your contribution is greatly appreciated.',
                                });
                                $('#completeButtonAlt').prop('disabled', true)
                            }
                        })
                    }
                    else{
                        $.alert({
                            title: 'Error!',
                            type: 'red',
                            content: 'There was an error submitting. Please contact the lead researcher.',
                        });
                        return
                    }
                }
                
            </script>
            
			<script src="assets/js/jquery.poptrox.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
           

	</body>
</html>